{% extends "base.html" %}

{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸{% endblock %}

{% block content %}
<div class="page-container">
  <div class="profile-card">

    <h2>ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>

    {% if user_type == 'student' %}
      
      <h3>å­¦ç”Ÿæƒ…å ±</h3>
      <div class="info-table">
        <table>
          <tr>
            <th>æ°å</th>
            <td>{{ profile.full_name }}</td>
          </tr>
          <tr>
            <th>å­¦å¹´</th>
            <td>{{ profile.grade }}</td>
          </tr>
          <tr>
            <th>å­¦æ ¡</th>
            <td>{{ profile.school.name | default:"æœªè¨­å®š" }}</td>
          </tr>
          <tr>
            <th>ãƒ­ã‚°ã‚¤ãƒ³ID</th>
            <td>{{ profile.user.username }}</td>
          </tr>
        </table>
      </div>
      
      <div style="text-align: right; margin-top: 10px;">
        <a href="{% url 'accounts:profile_update' %}" class="btn btn-edit">
          ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†
        </a>
        <a href="{% url 'accounts:student_tag_update' %}" class="btn btn-detail" style="margin-left: 10px;">
           ãƒãƒƒãƒãƒ³ã‚°ã‚¿ã‚°è¨­å®š
        </a>
      </div>

      {% if profile.comment %}
        <div class="teacher-comment-general">
          <h4>
            æ‹…å½“æ•™å“¡ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ
            {% if profile.comment_teacher %}
              <span>ï¼ˆè¨˜å…¥è€…: {{ profile.comment_teacher.full_name }} å…ˆç”Ÿï¼‰</span>
            {% endif %}
          </h4>
          <p>{{ profile.comment }}</p>
        </div>
      {% endif %}

      <hr>

      <h3>ãƒã‚¤ãƒ»ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªç®¡ç†</h3>
      
      <a href="{% url 'portfolios:create' %}" class="btn-create">
        ï¼‹ æ–°ã—ã„ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’ä½œæˆ
      </a>

      {% if portfolios %}
        <table class="portfolio-table">
          <thead>
            <tr>
              <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
              <th>èª¬æ˜ï¼ˆå†’é ­ï¼‰</th>
              <th style="width: 280px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {% for portfolio in portfolios %}
              <tr>
                <td>{{ portfolio.title }}</td>
                <td>{{ portfolio.description | truncatewords:15 }}</td>
                <td>
                  <a href="{% url 'portfolios:detail' portfolio.pk %}" class="btn btn-detail">
                    ä½œå“ç®¡ç†
                  </a>
                  <a href="{% url 'portfolios:update' portfolio.pk %}?next={% url 'accounts:my_page' %}" class="btn btn-edit">
                    ç·¨é›†
                  </a>
                  <a href="{% url 'portfolios:delete' portfolio.pk %}" class="btn btn-delete">
                    å‰Šé™¤
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>ã¾ã ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endif %}

      <hr>

      <!-- ======================= -->
    <!-- âœ… ã“ã“ã‹ã‚‰ã‚³ãƒ¼ãƒ‰æ¡ç‚¹ -->
    <!-- ======================= -->
 
    <h3>ã‚³ãƒ¼ãƒ‰æ¡ç‚¹</h3>
 
    <style>
      #loading-spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 3px solid #ccc;
        border-top: 3px solid #333;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: middle;
        margin-left: 8px;
      }
 
      @keyframes spin {
        100% { transform: rotate(360deg); }
      }
 
      .score-box {
        background: #f7f7ff;
        border-radius: 10px;
        padding: 15px;
        margin-top: 15px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      }
 
      .score-box h4 {
        margin-bottom: 10px;
      }
 
      .preview-box {
        margin-top: 10px;
        background: #111;
        color: #0f0;
        padding: 10px;
        border-radius: 6px;
        font-size: 12px;
        max-height: 300px;
        overflow: auto;
      }
    </style>
 
    <!-- ã‚¹ãƒ”ãƒŠãƒ¼ -->
    <div id="loading-spinner"></div>
 
    <!-- PDF ã¾ãŸã¯ ZIP -->
    <input type="file" id="file-input" accept=".pdf,.zip">
 
    <!-- æ¡ç‚¹ãƒœã‚¿ãƒ³ -->
    <button id="grade-btn" class="btn btn-detail" style="margin-top: 10px;">
      ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¡ç‚¹ã™ã‚‹
    </button>
 
    <!-- çµæœè¡¨ç¤º -->
    <div id="result"></div>
 
    <script>
    document.getElementById("grade-btn").addEventListener("click", async () => {
        const file = document.getElementById("file-input").files[0];
        const spinner = document.getElementById("loading-spinner");
        const resultDiv = document.getElementById("result");
 
        if (!file) {
            alert("PDF ã¾ãŸã¯ ZIP ã‚’é¸æŠã—ã¦ãã ã•ã„");
            return;
        }
 
        spinner.style.display = "inline-block";
        resultDiv.innerHTML = "";
 
        const formData = new FormData();
        formData.append("upload", file);
 
        const apiUrl = "https://overtrustfully-pinnatisect-jarod.ngrok-free.dev/grade_file/";
 
        try {
            const response = await fetch(apiUrl, {
                method: "POST",
                body: formData
            });
 
            const data = await response.json();
            console.log("ã‚µãƒ¼ãƒãƒ¼JSON:", data);
 
            if (data.error) {
                resultDiv.innerText = "ã‚¨ãƒ©ãƒ¼: " + data.error;
                return;
            }
 
            // âœ… ZIP ã®å ´åˆï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
            if (data.files) {
                data.files.forEach(f => {
                    const r = f.result;
 
                    resultDiv.innerHTML += `
                    <div class="score-box">
                      <h4>ğŸ“„ ${f.filename}</h4>
                      æ­£ç¢ºæ€§: ${r.æ­£ç¢ºæ€§} / 25<br>
                      å¯èª­æ€§: ${r.å¯èª­æ€§} / 25<br>
                      ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${r["ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹"]} / 25<br>
                      ã‚¹ã‚¿ã‚¤ãƒ«: ${r.ã‚¹ã‚¿ã‚¤ãƒ«} / 25<br>
                      <b>ç·åˆ: ${r.ç·åˆ} / 100</b><br><br>
                      ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆ:<br>${r.ã‚³ãƒ¡ãƒ³ãƒˆ}
                      <div class="preview-box">${f.preview}</div>
                    </div>
                    `;
                });
 
            // âœ… PDF å˜ä½“
            } else {
                const r = data.result;
 
                resultDiv.innerHTML = `
                <div class="score-box">
                  <h4>ğŸ“„ ${data.filename}</h4>
                  æ­£ç¢ºæ€§: ${r.æ­£ç¢ºæ€§} / 25<br>
                  å¯èª­æ€§: ${r.å¯èª­æ€§} / 25<br>
                  ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${r["ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹"]} / 25<br>
                  ã‚¹ã‚¿ã‚¤ãƒ«: ${r.ã‚¹ã‚¿ã‚¤ãƒ«} / 25<br>
                  <b>ç·åˆ: ${r.ç·åˆ} / 100</b><br><br>
                  ğŸ“ ã‚³ãƒ¡ãƒ³ãƒˆ:<br>${r.ã‚³ãƒ¡ãƒ³ãƒˆ}
                  <div class="preview-box">${data.preview}</div>
                </div>
                `;
            }
 
        } catch (err) {
            resultDiv.innerText = "é€šä¿¡ã‚¨ãƒ©ãƒ¼: " + err;
        } finally {
            spinner.style.display = "none";
        }
    });
    </script>
 
    <!-- ======================= -->
    <!-- âœ… æ¡ç‚¹ã“ã“ã¾ã§ -->
    <!-- ======================= -->


      {% elif user_type == 'teacher' %}
      <h3>æ•™å“¡æƒ…å ±</h3>
      <div class="info-table">
        <table>
          <tr>
            <th>æ°å</th>
            <td>{{ profile.full_name }}</td>
          </tr>
          <tr>
            <th>æ‹…å½“æ•™ç§‘</th>
            <td>{{ profile.subject }}</td>
          </tr>
          <tr>
            <th>å­¦æ ¡</th>
            <td>{{ profile.school.name | default:"æœªè¨­å®š" }}</td>
          </tr>
          <tr>
            <th>ãƒ­ã‚°ã‚¤ãƒ³ID</th>
            <td>{{ profile.user.username }}</td>
          </tr>
        </table>
      </div>

      <div style="text-align: right; margin-top: 10px;">
        <a href="{% url 'accounts:profile_update' %}" class="btn btn-edit">
          ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†
        </a>
      </div>

{% elif user_type == 'company' %}
      
      <h3>æ‹…å½“è€…æƒ…å ±</h3>
      <div class="info-table">
         <table>
          <tr>
            <th>æ‰€å±ä¼æ¥­</th>
            <td>{{ profile.company.name }}</td>
          </tr>
          <tr>
            <th>æ‹…å½“è€…å</th>
            <td>{{ profile.full_name }}</td>
          </tr>
          <tr>
            <th>æ‰€å±éƒ¨ç½²</th>
            <td>{{ profile.department | default:"æœªè¨­å®š" }}</td>
          </tr>
           <tr>
            <th>ãƒ­ã‚°ã‚¤ãƒ³ID</th>
            <td>{{ profile.user.username }}</td>
          </tr>
        </table>
      </div>

      <h4 style="margin-top: 2rem;">ä¼æ¥­æƒ…å ±</h4>
      <div class="info-table">
         <table>
          <tr>
            <th>æ¥­ç¨®</th>
            <td>{{ profile.company.industry }}</td>
          </tr>
          <tr>
            <th>äº‹æ¥­å†…å®¹</th>
            <td class="description">{{ profile.company.description | linebreaksbr }}</td>
          </tr>
        </table>
      </div>

      <div style="text-align: right; margin-top: 15px;">
        
        <a href="#" class="btn btn-edit">
          æ‹…å½“è€…ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†
        </a>

        <a href="{% url 'accounts:company_tag_update' %}" class="btn btn-edit"style="margin-left: 10px; color: #d9a900; border: none;">
           ãƒãƒƒãƒãƒ³ã‚°ã‚¿ã‚°è¨­å®š
        </a>

      </div>
      
    {% endif %}

    <hr>

    <a href="{% url 'accounts:dashboard' %}" class="back-link" style="display: block; margin-top: 20px;">
      â† ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
    </a>

  </div>
</div>
{% endblock %}