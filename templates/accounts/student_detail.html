{% extends "base.html" %}
{% load static %} 

{% block title %}{{ student.full_name }}ã•ã‚“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª{% endblock %}

{% block content %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('student-detail-page');
  });
</script>

<div class="page-container">
  <div class="profile-card">

    <h2>{{ student.full_name }} ã•ã‚“ã®è©³ç´°</h2>
    
    {% if user.companyrepresentative and match_rate is not None %}
      <div style="margin-bottom: 20px; padding: 15px; background-color: #fff5f5; border: 2px solid #ff6b6b; border-radius: 10px; color: #c0392b; text-align: center;">
        <span style="font-size: 1.1rem;">è²´ç¤¾ã¨ã®ãƒãƒƒãƒåº¦</span><br>
        <span style="font-size: 2.5rem; font-weight: bold; line-height: 1.2;">{{ match_rate }}%</span>
        
        {% if matched_strengths or matched_conditions %}
          <hr style="border-top: 1px dashed #ffcccc; margin: 15px 0;">
          <div style="text-align: left; font-size: 0.95rem;">
            
            {% if matched_strengths %}
              <div style="margin-bottom: 8px;">
                <strong style="color: #e53e3e;">âš¡ ãƒãƒƒãƒã—ãŸã‚¹ã‚­ãƒ«ãƒ»å¼·ã¿:</strong><br>
                {% for tag in matched_strengths %}
                  <span style="display: inline-block; background: #fff; border: 1px solid #fc8181; color: #c53030; padding: 2px 8px; border-radius: 15px; font-size: 0.85rem; margin: 2px;">
                    {{ tag }}
                  </span>
                {% endfor %}
              </div>
            {% endif %}

            {% if matched_conditions %}
              <div>
                <strong style="color: #3182ce;">ğŸ¤ ãƒãƒƒãƒã—ãŸæ¡ä»¶ãƒ»å¾…é‡:</strong><br>
                {% for tag in matched_conditions %}
                  <span style="display: inline-block; background: #fff; border: 1px solid #63b3ed; color: #2b6cb0; padding: 2px 8px; border-radius: 15px; font-size: 0.85rem; margin: 2px;">
                    {{ tag }}
                  </span>
                {% endfor %}
              </div>
            {% endif %}
            
          </div>
        {% endif %}
      </div>
    {% endif %}


    {% if user.companyrepresentative %} 
      <div class="action-box">
        
        {% if is_scouted %}
          <form action="{% url 'accounts:remove_scout' student.pk %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn-cancel">ã‚¹ã‚«ã‚¦ãƒˆã‚’å–ã‚Šæ¶ˆã™</button>
          </form>
        {% else %}
          <form action="{% url 'accounts:add_scout' student.pk %}" method="post">
            {% csrf_token %}
            <button type="submit" class="btn-scout">ã“ã®å­¦ç”Ÿã‚’ã‚¹ã‚«ã‚¦ãƒˆã™ã‚‹</button>
          </form>
        {% endif %}
        
        {% url 'accounts:student_detail' student.pk as student_detail_url %}
        
        {% if student_chat_room_id %}
          <a href="{% url 'chat:chat_room' student_chat_room_id %}?next={{ student_detail_url }}" class="btn-chat">ã“ã®å­¦ç”Ÿã¨ãƒãƒ£ãƒƒãƒˆã‚’ç¶šã‘ã‚‹</a>
        {% else %}
          <a href="{% url 'chat:start_chat' student.user.id %}?next={{ student_detail_url }}" class="btn-chat">ã“ã®å­¦ç”Ÿã¨ãƒãƒ£ãƒƒãƒˆã‚’é–‹å§‹ã™ã‚‹</a>
        {% endif %}

      </div>
    {% endif %}

    <div class="info-table">
      <table>
        <tr>
          <th>æ°å</th>
          <td>{{ student.full_name }}</td>
        </tr>
        <tr>
          <th>å­¦æ ¡å</th>
          <td>{{ student.school.name | default:"æœªè¨­å®š" }}</td>
        </tr>
        <tr>
          <th>å­¦å¹´</th>
          <td>{{ student.grade }}å¹´</td>
        </tr>
      </table>
    </div>

    {% if student.comment %}
      <div class="teacher-comment-general">
        <h4>
          æ‹…å½“æ•™å“¡ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ
          {% if student.comment_teacher %}
            <span>ï¼ˆè¨˜å…¥è€…: {{ student.comment_teacher.full_name }} å…ˆç”Ÿï¼‰</span>
          {% endif %}
        </h4>
        <p style="white-space: pre-wrap;">{{ student.comment }}</p>
        
        {% if user.teacher and user.teacher.school == student.school %}
          <a href="{% url 'accounts:student_comment_update' student.pk %}" 
             class="comment-edit-link" 
             style="background-color: #dbeafe; padding: 4px 8px; border-radius: 5px;">
            [ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†ã™ã‚‹]
          </a>
        {% endif %}
      </div>
    {% else %}
      {% if user.teacher and user.teacher.school == student.school %}
        <div class="teacher-comment-general" style="background-color: #f9f9f9;">
          <a href="{% url 'accounts:student_comment_update' student.pk %}" 
             class="comment-edit-link"
             style="font-weight: 600;">
            [æ‹…å½“æ•™å“¡ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹]
          </a>
        </div>
      {% endif %}
    {% endif %}
    
    {% if user.companyrepresentative and school_teachers %}
    <div class="teacher-chat-box">
      <h4>
        {{ student.school.name }} ã®æ‹…å½“æ•™å“¡
        <span>ï¼ˆå­¦ç”Ÿã«é–¢ã™ã‚‹è³ªå•ã¯ã“ã¡ã‚‰ã¸ï¼‰</span>
      </h4>
      <ul>
        {% for teacher in school_teachers %}
          <li>
            {{ teacher.full_name }} å…ˆç”Ÿ
            <a href="{% url 'chat:start_chat' teacher.user.id %}?next={{ student_detail_url }}">
              ãƒãƒ£ãƒƒãƒˆ
            </a>
          </li>
        {% empty %}
          <li>ï¼ˆã¾ã æ‹…å½“æ•™å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    

    <hr>
    <h3>ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªä¸€è¦§</h3>
    
    {% if portfolios %}
      {% for portfolio in portfolios %}
        <div class="portfolio-card" style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px;">
          <h4>{{ portfolio.title }}</h4>
          <p>{{ portfolio.description | linebreaksbr }}</p>
          
          {% if portfolio.teacher_comment %}
            <div class="teacher-comment-portfolio">
              <strong>
                æ•™å“¡ã‚³ãƒ¡ãƒ³ãƒˆ
                {% if portfolio.commenting_teacher %}
                <span>({{ portfolio.commenting_teacher.full_name }} å…ˆç”Ÿ)</span>
                {% endif %}
              </strong>
              <p>{{ portfolio.teacher_comment }}</p>
            </div>
          {% endif %}

          {% if user.teacher and user.teacher.school == student.school %}
            <a href="{% url 'portfolios:portfolio_comment_update' portfolio.pk %}" class="comment-edit-link">
              ã“ã®ä½œå“ã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹
            </a>
          {% endif %}

          <h5 style="margin-top: 15px;">æˆæœç‰©</h5>
          {% if portfolio.items.all %}
            <ul style="list-style-type: none; padding-left: 0;">
              {% for item in portfolio.items.all %}
                <li style="background: #f4f4f4; border: 1px solid #eee; padding: 8px; margin-bottom: 5px;">
                  <a href="{{ item.file.url }}" target="_blank">
                    {{ item.file.name }}
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>ï¼ˆã“ã®ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã«æˆæœç‰©ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</p>
          {% endif %}
        </div>
      {% endfor %}
    {% else %}
      <p>ï¼ˆã“ã®å­¦ç”Ÿã¯ã¾ã ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’ä½œæˆã—ã¦ã„ã¾ã›ã‚“ï¼‰</p>
    {% endif %}

    <hr>
    
    {% if user.teacher %}
      <a href="{% url 'accounts:teacher_student_list' %}" class="back-link">â† æ‹…å½“å­¦ç”Ÿä¸€è¦§ã«æˆ»ã‚‹</a>
    {% elif user.companyrepresentative %}
      <a href="{% url 'accounts:company_student_list' %}" class="back-link">â† å­¦ç”Ÿæ¤œç´¢ä¸€è¦§ã«æˆ»ã‚‹</a>
    {% endif %}

  </div>
</div>
{% endblock %}